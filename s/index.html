<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tracking</title>
</head>
<body>
  <p id="status">Erfasse anonym …</p>

<script>
  const params = new URLSearchParams(location.search);
  const station = (params.get("station") || "").toUpperCase();

  const KEY = "exhibit_user_id";
  let user_id = localStorage.getItem(KEY);
  if (!user_id) {
    user_id = (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2)) + "-" + Date.now();
    localStorage.setItem(KEY, user_id);
  }

  const ts = new Date().toISOString();
  const payload = { user_id, ts, station };

  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwq88FBuldTNMkQQeRQ9s8_4bOKdGkGtITBgWl2gHOSWw2QyQj3BzrU6Aj0iWEz8VYqdg/exec";

  async function send() {
    const el = document.getElementById("status");

    if (!station) {
      el.textContent = "Fehler: ?station= fehlt";
      return;
    }

    try {
      // Wichtig:
      // - mode:"no-cors" vermeidet CORS-Fehler im Browser
      // - kein res.json(), weil no-cors die Antwort "opaque" macht
      await fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      el.textContent = "OK – gesendet.";
    } catch (e) {
      // Hier landen wir nur bei echten Netzwerkfehlern
      el.textContent = "Fehler beim Senden (Netzwerk).";
      console.error(e);
    }
  }

  send();
</script>
</body>
</html>
